import numpy as np
import porespy as ps
import openpnm as op
import matplotlib.pyplot as plt
from skimage import measure
import scipy
import openpnm.models.physics as physics

# 1) Generate sphere packing
shape = [120, 120, 80]  # domain size
radii = 2  # sphere radius in voxels (controls porosity / throat sizes)
dist = scipy.stats.norm(loc=radii, scale=1.0)  # normal distribution of sphere sizes
im = ps.generators.polydisperse_spheres(shape=shape, r_min=radii, porosity=0.6, dist=dist)  # initial porous structure

"""
# visualisation of central slice
plt.imshow(im[:, :, shape[2]//2])
plt.title('Packed spheres slice')
plt.show()
"""

# 2) Extract pore network from the image using PoreSpy SNOW2 + OpenPNM network extraction
snow_dict = ps.networks.snow2(im, voxel_size=1.0)
pn = op.io.network_from_porespy(snow_dict.network)
pn['pore.diameter'] = pn['pore.inscribed_diameter']
pn['throat.diameter'] = pn['throat.inscribed_diameter']

# Condition pn with geometric models
pn.add_model(
    propname='pore.volume',
    model=op.models.geometry.pore_volume.sphere,
    pore_diameter='pore.diameter'
)
pn.add_model(
    propname='pore.area',
    model=op.models.geometry.pore_cross_sectional_area.sphere,
    pore_diameter='pore.diameter'
)
pn.add_model(
    propname='throat.cross_sectional_area',
    model=op.models.geometry.throat_cross_sectional_area.cylinder,
    throat_diameter='throat.diameter'
)

pn.add_model(
    propname='throat.hydraulic_size_factors',
    model=op.models.geometry.hydraulic_size_factors.pyramids_and_cuboids,
    pore_diameter='pore.diameter',
    throat_diameter='throat.diameter'
)

# 3) Create OpenPNM Project and add phase & physics
proj = op.Project()
phase = op.phase.Water(network=pn)
phase['pore.viscosity'] = 3.15e-4  # Pa.s
phase['throat.viscosity'] = 3.15e-4  # Pa.s

phase.add_model(propname='throat.hydraulic_conductance',
                model=physics.hydraulic_conductance.hagen_poiseuille,
                pore_viscosity='pore.viscosity',
                throat_viscosity='throat.viscosity',
                size_factors='throat.hydraulic_size_factors'
)

phase.add_model(
    propname='throat.diffusive_conductance',
    model=op.models.physics.diffusive_conductance.generic_diffusive,
    pore_diffusivity='pore.diffusivity',
    throat_diffusivity='throat.diffusivity',
    size_factors='diffusive_size_factors'
)

# 4) Run Stokes-like flow (Darcy on network) to get fluxes
flow = op.algorithms.StokesFlow(network=pn, phase=phase)
coords = pn.coords
tol = 1e-6
left_pores = pn.pores()[coords[:,0] <= coords[:,0].min() + tol]
right_pores = pn.pores()[coords[:,0] >= coords[:,0].max() - tol]

flow.set_value_BC(pores=left_pores, values=1.0)
flow.set_value_BC(pores=right_pores, values=0.0)

flow.run()

# 5) Run advection-diffusion (steady/tracer)
ad = op.algorithms.AdvectionDiffusion(network=pn, phase=phase)
phase.add_model(
    propname='throat.ad_dif_conductance',
    model=op.models.physics.ad_dif_conductance.ad_dif,
    throat_hydraulic_conductance='throat.hydraulic_conductance',
    throat_diffusive_conductance='throat.diffusive_conductance',
    pore_pressure='pore.pressure',
    s_scheme='powerlaw'
)

# Adds boundary conditions for tracers
ad.set_value_BC(pores=left_pores, values=1.0)  # normalized concentration
ad.set_value_BC(pores=right_pores, values=0.0)  # outlet
ad.run()
C = ad['pore.concentration']

# 6) Visualize pore concentrations (simple)
plt.hist(C, bins=40)
plt.xlabel('Pore concentration')
plt.show()
