import numpy as np
import porespy as ps
import openpnm as op
import matplotlib.pyplot as plt
from skimage import measure
import scipy
import openpnm.models.physics as physics
import vtk # optional for VTK writes, or use openpnm exporters

# 1) Generate a 3D sphere packing (voxels)
shape = [120, 120, 80]  # small domain for presentation; change as needed
radii = 4  # sphere radius in voxels (controls porosity / throat sizes)
dist = scipy.stats.norm(loc=radii, scale=1.0)  # normal distribution of sphere sizes
im = ps.generators.polydisperse_spheres(shape=shape, r_min=radii, porosity=0.5, dist=dist)  # initial porous structure

# optional: visualize central slice
plt.imshow(im[:, :, shape[2]//2])
plt.title('Packed spheres slice')
plt.show()

# 2) Extract pore network from the image using PoreSpy SNOW + OpenPNM network extraction
snow_dict = ps.networks.snow2(im, voxel_size=1.0)
pn = op.io.network_from_porespy(snow_dict.network)

# If the above wrapper isn't available, use porespy's snow algorithm to get coordinates,
# then build an OpenPNM network with those coords (see docs/examples).

# 3) Create OpenPNM Project and add phase & physics
proj = op.Project()
phase = op.phase.Water(network=pn)


# 4) Run Stokes-like flow (Darcy on network) to get fluxes
flow = op.algorithms.StokesFlow(network=pn, phase=phase)
coords = pn.coords
tol = 1e-6
left_pores = pn.pores()[coords[:,0] <= coords[:,0].min() + tol]
right_pores = pn.pores()[coords[:,0] >= coords[:,0].max() - tol]

flow.set_value_BC(pores=left_pores, values=1.0)
flow.set_value_BC(pores=right_pores, values=0.0)

flow.run()

# 5) Run advection-diffusion (steady/tracer)
ad = op.algorithms.AdvectionDiffusion(network=pn, phase=phase)
ad.setup(pore_diffusivity=1e-9)  # example diffusivity (m2/s) scaled to your units
ad.set_source(pores=pn.pores('left'), values=1.0)  # tracer injection
ad.run()
C = ad['pore.concentration']

# 6) Visualize pore concentrations (simple)
plt.hist(C, bins=40)
plt.xlabel('Pore concentration')
plt.show()